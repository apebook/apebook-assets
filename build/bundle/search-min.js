KISSY.add("apebook/bundle/search",["lodash","lunr"],function(o,e,t,a){function i(){function o(o){u=r.Index.load(o)}function e(){$.get(gitbook.state.basePath+"/search_index.json").then(o)}function t(o){if(u){var e=n.chain(u.search(o)).map(function(o){var e=o.ref.split("#");return{path:e[0],hash:e[1]}}).value();return e}}function a(o){c&&c.remove(),c=$("<div>",{"class":"book-search",role:"search"}),b=$("<input>",{type:"text","class":"form-control",val:o,placeholder:"Type to search"}),b.appendTo(c),c.prependTo(gitbook.state.$book.find(".book-summary"))}function i(){return gitbook.state.$book.hasClass("with-search")}function s(o){i()!==o&&(gitbook.state.$book.toggleClass("with-search",o),i()?(gitbook.sidebar.toggle(!0),b.focus(),e()):(b.blur(),b.val(""),gitbook.sidebar.filter(null)))}function l(){var o=gitbook.storage.get("keyword","");a(o),o.length>0&&(i()||s(),gitbook.sidebar.filter(n.pluck(t(o),"path")))}var b,c,u=null;gitbook.events.bind("start",function(){a(),$(document).on("keyup",".book-search input",function(o){var e=o.keyCode?o.keyCode:o.which,a=$(this).val();if(27==e)return o.preventDefault(),void s(!1);if(0==a.length)gitbook.sidebar.filter(null),gitbook.storage.remove("keyword");else{var i=t(a);gitbook.sidebar.filter(n.pluck(i,"path")),gitbook.storage.set("keyword",a)}}),gitbook.toolbar.createButton({icon:"fa fa-search",label:"Search",position:"left",onClick:s}),gitbook.keyboard.bind(["f"],s)}),gitbook.events.bind("page.change",l)}var n=e("lodash"),r=e("lunr");a.exports={init:i}});