KISSY.add("apebook/bundle/navigation",["jquery","url","./events","./state","./loading"],function(t,n,e,a){function o(t,n){var e=v.resolve(window.location.pathname,t);return k?y.show(h.get(e).done(function(t){n&&history.pushState({path:e},null,e),t=t.replace(/<(\/?)(html|head|body)([^>]*)>/gi,function(t,n,e,a){return"<"+n+"div"+(n?"":' data-element="'+e+'"')+a+">"});var a=h(t),o=a.find("[data-element=head]"),i=a.find(".book");document.title=o.find("title").text();var r=h("head");r.find("link[rel=prev]").remove(),r.find("link[rel=next]").remove(),r.append(o.find("link[rel=prev]")),r.append(o.find("link[rel=next]"));var s=h(".book").attr("class"),c=h(".book-summary .summary").scrollTop();i.toggleClass("with-summary",h(".book").hasClass("with-summary")),h(".book").replaceWith(i),h(".book").attr("class",s),h(".book-summary .summary").scrollTop(c),g.update(h("html")),l()}).fail(function(){location.href=t})):void(location.href=t)}function i(){var t,n;t=parseInt(h(".body-inner").css("width"),10),n=parseInt(h(".page-wrapper").css("width"),10),h(".navigation-next").css("margin-right",t-n+"px")}function r(){m.trigger("page.change")}function l(t){var n=h(".book-body"),e=n.find(".body-inner"),a=e.find(".page-wrapper");i(),a.focus(),e.scrollTop(0),n.scrollTop(0),t!==!1&&r()}function s(t){return 0===t.button}function c(t){return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}function u(t){if(!c(t)&&s(t)){t.stopPropagation(),t.preventDefault();var n=h(this).attr("href");n&&o(n,!0)}}function d(){var t=h(".navigation-next").attr("href");t&&o(t,!0)}function p(){var t=h(".navigation-prev").attr("href");t&&o(t,!0)}function f(){h.ajaxSetup({cache:!1}),history.replaceState({path:window.location.href},""),window.onpopstate=function(t){return null!==t.state?o(t.state.path,!1):void 0},h(document).on("click",".navigation-prev",u),h(document).on("click",".navigation-next",u),h(document).on("click",".summary [data-path] a",u),h(window).resize(i),l(!1)}var h=n("jquery"),v=n("url"),m=n("./events"),g=n("./state"),y=n("./loading"),k="undefined"!=typeof history.pushState;a.exports={init:f,goNext:d,goPrev:p,notify:r}});